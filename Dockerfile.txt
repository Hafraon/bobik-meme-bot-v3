# üß†üòÇüî• –£–∫—Ä–∞—ó–Ω–æ–º–æ–≤–Ω–∏–π Telegram-–±–æ—Ç - Docker –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è üß†üòÇüî•

# –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π Python –æ–±—Ä–∞–∑
FROM python:3.11-slim

# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    libpq-dev \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä–æ–±–æ—á–æ—ó –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó
WORKDIR /app

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–ª—è –±–µ–∑–ø–µ–∫–∏
RUN groupadd -r botuser && useradd -r -g botuser botuser

# –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è requirements.txt —Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è –∫–æ–¥—É –¥–æ–¥–∞—Ç–∫–∞
COPY . .

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ–π
RUN mkdir -p logs data && \
    chown -R botuser:botuser /app

# –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –Ω–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ botuser
USER botuser

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–º—ñ–Ω–Ω–∏—Ö —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
ENV PYTHONPATH=/app
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# –ü–æ—Ä—Ç –¥–ª—è health check —Å–µ—Ä–≤–µ—Ä–∞
EXPOSE 8080

# Health check
HEALTHCHECK --interval=30s --timeout=30s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# –ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫—É
CMD ["python", "main.py"]

# Multi-stage build –¥–ª—è production
FROM python:3.11-slim as production

# –°–∏—Å—Ç–µ–º–Ω—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –¥–ª—è production
RUN apt-get update && apt-get install -y \
    libpq5 \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
RUN groupadd -r botuser && useradd -r -g botuser botuser

# –†–æ–±–æ—á–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è
WORKDIR /app

# –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –µ—Ç–∞–ø—É
COPY --from=0 /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
COPY --from=0 /usr/local/bin /usr/local/bin
COPY --from=0 --chown=botuser:botuser /app /app

# –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –Ω–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
USER botuser

# –ó–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
ENV PYTHONPATH=/app
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# –ü–æ—Ä—Ç
EXPOSE 8080

# Health check
HEALTHCHECK --interval=30s --timeout=30s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# –ó–∞–ø—É—Å–∫
CMD ["python", "main.py"]